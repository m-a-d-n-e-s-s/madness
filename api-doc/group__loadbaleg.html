<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MADNESS: Data and load balancing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MADNESS<span id="projectnumber">&#160;0.10.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">Data and load balancing</div></div>
</div><!--header-->
<div class="contents">
<p>The source is <a href="https://github.com/m-a-d-n-e-s-s/madness/blob/master/src/examples/dataloadbal.cc">here</a>.</p>
<p>This is one of the more computationally demanding examples - either run it on 50 or more nodes of jaguar or reduce the number of functions employed (value of <code>NFUNC</code> in the source).</p>
<dl class="section user"><dt>Points of interest</dt><dd><ul>
<li>Using functors to incorporate state into functions to be compressed</li>
<li>Using special points in a functor to provide hints to adaptive refinement algorithm</li>
<li>Operating on multiple functions in a vector</li>
<li>Heuristic analysis of function trees to generate a new mapping of data to processor</li>
<li>Installation of the new process map with automatic redistribution of data</li>
<li>Timing to estimate benefit of load balancing</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Background</dt><dd></dd></dl>
<p>Poor distribution of work (load imbalance) is the largest reason for inefficient parallel execution within MADNESS. Poor data distribution (data imbalance) contributes to load imbalance and also leads to out-of-memory problems due to one or more processes having too much data. Thus, we are interested in uniform distribution of both work and data.</p>
<p>Many operations in MADNESS are entirely data driven (i.e., computation occurs in the processor that "owns" the data) since there is insufficient work to justify moving data between processes (e.g., computing the inner product between functions). However, a few expensive operations can have work shipped to other processors.</p>
<p>There are presently three load balancing mechanisms within MADNESS</p><ul>
<li>static and driven by the distribution of data,</li>
<li>dynamic via random assignment of work, and</li>
<li>dynamic via work stealing (currently only in prototype).</li>
</ul>
<p>Until the work stealing becomes production quality we must exploit the first two forms. The random work assignment is controlled by options in the FunctionDefaults class.</p><ul>
<li><a class="el" href="classmadness_1_1FunctionDefaults.html#a16b3fe68b9dfcb79d00cdc2a6e6f0168" title="Sets the random load balancing for integral operators flag.">FunctionDefaults::set_apply_randomize(bool)</a> controls the use of randomization in applying integral (convolution) operators. It is typically beneficial when computing to medium/high precision.</li>
<li><a class="el" href="classmadness_1_1FunctionDefaults.html#a6f0c94015bce7d686588cbc94045d81c" title="Sets the random load balancing for projection flag.">FunctionDefaults::set_project_randomize(bool)</a> constrols the use of randomization in projecting from an analytic form (i.e., C++) into the discontinuous spectral element basis. It is typically beneficial unless there is already a good static data distribution. Since these options are straightforward to enable, this example focusses on static data redistribution.</li>
</ul>
<p>The process map (an instance of WorldDCPmapInterface) controls mapping of data to processors and it is actually quite easy to write your own (e.g., see WorldDCDefaultPmap or <a class="el" href="classLevelPmap.html">LevelPmap</a>) that ensure uniform data distribution. However, you also seek to incorporate estimates of the computational cost into the distribution. The class LBDeuxPmap (deux since it is the second such class) in <a class="el" href="lbdeux_8h.html" title="Implements (2nd generation) static load/data balancing for functions.">mra/lbdeux.h</a> does this by examining the functions you request and using provided weights to estimate the computational cost. Communication costs are proportional to the number of broken links in the tree. Since some operations work in the scaling function basis, some in the wavelet basis, and some in non-standard form, there is an element of empiricism in getting best performance from most algorithms.</p>
<dl class="section user"><dt>Implementation</dt><dd></dd></dl>
<p>The example times how long it takes to perform the following operations</p><ul>
<li>constructing 4000 <a class="el" href="classGaussian.html">Gaussian</a> functions with random exponent and origin,</li>
<li>truncating them,</li>
<li>differentiating them, and</li>
<li>applying the Coulomb Green's function to them.</li>
</ul>
<p>The process map (data distribution) is then modified using the LBDeux heuristic and the operations repeated.</p>
<dl class="section user"><dt>Results</dt><dd></dd></dl>
<pre class="fragment">/tmp/work/harrison % aprun -n 50 -d 12 -cc none ./dataloadbal
Runtime initialized with 10 threads in the pool and affinity 1 0 2
Before load balancing
project 2.57 truncate 9.18 differentiate 11.80 convolve 12.57 balance 0.00
project 2.74 truncate 9.08 differentiate 11.33 convolve 13.07 balance 0.00
project 2.80 truncate 8.84 differentiate 10.76 convolve 12.66 balance 2.19
After load balancing
project 2.96 truncate 2.56 differentiate 3.28 convolve 9.81 balance 0.00
project 3.05 truncate 2.61 differentiate 3.46 convolve 9.24 balance 0.00
project 3.01 truncate 2.60 differentiate 3.25 convolve 9.30 balance 0.00
</pre> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jan 28 2026 13:36:10 for MADNESS by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
