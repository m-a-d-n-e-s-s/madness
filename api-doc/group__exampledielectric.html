<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MADNESS: Poisson&#39;s equation in a dielectric medium</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MADNESS<span id="projectnumber">&#160;0.10.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">Poisson's equation in a dielectric medium</div></div>
</div><!--header-->
<div class="contents">
<p>The source is <a href="https://github.com/m-a-d-n-e-s-s/madness/blob/master/src/examples/dielectric.cc">here</a>.</p>
<dl class="section user"><dt>Points of interest</dt><dd><ul>
<li>use of iterative equation solver</li>
<li>convolution with the Green's function</li>
<li>unary operator to compute reciprocal of a function</li>
<li>use of diffuse domain approximation to represent interior surfaces</li>
<li>line and volume plots</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Background</dt><dd></dd></dl>
<p>We wish to solve Poisson's equation within a non-homogeneous medium, i.e., in which the permittivity is not constant.  </p><p class="formulaDsp">
<picture><source srcset="form_130_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
\nabla . \left( \epsilon(r) \nabla u(r)  \right) = - 4 \pi \rho(r)
\]" src="form_130.png"/></picture>
</p>
<p> Expanding and rearranging yields,  </p><p class="formulaDsp">
<picture><source srcset="form_131_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   \nabla^2 u(r) = - \frac{1}{\epsilon(r)} \left( 4 \pi \rho(r) + \nabla \epsilon(r) .  \nabla u(r) \right)
\]" src="form_131.png"/></picture>
</p>
<p> We can interpret <picture><source srcset="form_132_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\rho / \epsilon$" src="form_132.png"/></picture> as the effective free charge density and <picture><source srcset="form_118_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\nabla \epsilon . \nabla u / \epsilon$" src="form_118.png"/></picture> as the induced surface charge density. Assuming free-space boundary conditions at long range we can invert the Laplacian by convolution with the free-space Green's function that is <picture><source srcset="form_125_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$-1 / 4 \pi |r-s|$" src="form_125.png"/></picture>. Note that MADNESS provides convolution with <picture><source srcset="form_126_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$G(r,s) = 1/|r-s|$" src="form_126.png"/></picture> so you have to keep track of the <picture><source srcset="form_127_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$-1/4\pi$" src="form_127.png"/></picture> yourself.</p>
<p>Thus, our equation becomes (deliberately written in the form of a fixed point iteration &mdash; given a guess for <picture><source srcset="form_58_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$u$" src="form_58.png"/></picture> we can compute the r.h.s. and directly obtain a new value for <picture><source srcset="form_58_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$u$" src="form_58.png"/></picture> that hopefully is closer to the solution)  </p><p class="formulaDsp">
<picture><source srcset="form_133_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   u = G * \left(\rho_{\mbox{vol}} + \rho_{\mbox{surf}} \right)
\]" src="form_133.png"/></picture>
</p>
<p> where  </p><p class="formulaDsp">
<picture><source srcset="form_134_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   \rho_{\mbox{vol}} = \frac{\rho}{\epsilon}
\]" src="form_134.png"/></picture>
</p>
<p> and  </p><p class="formulaDsp">
<picture><source srcset="form_135_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   \rho_{\mbox{surf}} = \frac{\nabla \epsilon .  \nabla u}{4 \pi \epsilon}
\]" src="form_135.png"/></picture>
</p>
<p>Let's solve a problem to which we know the exact answer &mdash; a point charge at the center of a sphere <picture><source srcset="form_136_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$R=2$" src="form_136.png"/></picture>. Inside the sphere the permittivity is <picture><source srcset="form_137_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\epsilon_1 = 1$" src="form_137.png"/></picture> and outside it is <picture><source srcset="form_138_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\epsilon_2 = 10$" src="form_138.png"/></picture>. The exact solution is  </p><p class="formulaDsp">
<picture><source srcset="form_139_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   u(r) =
          \left \lbrace
             \begin{array}{cc}
                  \frac{1}{\epsilon_2 |r|} &amp; |r| &gt; R \\
                  \frac{1}{\epsilon_1 |r|} + \left( \frac{1}{\epsilon_2} - \frac{1}{\epsilon_1} \right) \frac{1}{R}  &amp; |r| &lt; R
             \end{array}
          \right .
\]" src="form_139.png"/></picture>
</p>
<p> The surface charge density integrated over the suface has the value  </p><p class="formulaDsp">
<picture><source srcset="form_140_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   q_{\mbox{surface}} = -\frac{\epsilon_2 - \epsilon_1}{\epsilon_2} = -0.9
\]" src="form_140.png"/></picture>
</p>
<p>To implement the problem in MADNESS we want the permittivity defined as a function over all space, so we define a characteristic function <picture><source srcset="form_141_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$C(r)$" src="form_141.png"/></picture> (or mask) that is defined to be one inside the sphere and zero outside  </p><p class="formulaDsp">
<picture><source srcset="form_142_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
  C(r) = H(R-|r|)
\]" src="form_142.png"/></picture>
</p>
<p> where <picture><source srcset="form_143_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$H(x)$" src="form_143.png"/></picture> is the Heaviside step function. Hence, we have  </p><p class="formulaDsp">
<picture><source srcset="form_144_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   \epsilon(r) = \epsilon_1 C(r) + \epsilon_2 \left( 1 - C(r) \right)
\]" src="form_144.png"/></picture>
</p>
<p> To smooth the discontinuity we replace the Heaviside step function with  </p><p class="formulaDsp">
<picture><source srcset="form_145_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   H(x,\sigma) = \frac{1}{2} \left( 1 + \mathop{\mathrm{erf}} \frac{x}{\sigma} \right)
\]" src="form_145.png"/></picture>
</p>
<p> where <picture><source srcset="form_146_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\sigma$" src="form_146.png"/></picture> is the effective width of the step (0.2 in the code). Similarly, the point charge is replaced by a suitably normalized <a class="el" href="classGaussian.html">Gaussian</a> with a an exponent sufficiently large as to appear as a point charge (delta function) on the scale of interest (we pick <picture><source srcset="form_147_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\xi=100$" src="form_147.png"/></picture>)  </p><p class="formulaDsp">
<picture><source srcset="form_148_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   \rho(r) = \left(\pi \xi \right)^{-3/2} e^{-\xi |r|^2}
\]" src="form_148.png"/></picture>
</p>
<p>Starting from an initial guess we could try to iterate our equation for <picture><source srcset="form_149_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$u(r)$" src="form_149.png"/></picture> but, sadly, this does not converge reliably. The simplest approach is to introduce some damping or step restriction. With <picture><source srcset="form_150_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$m$" src="form_150.png"/></picture> indicating the iteration number, we write  </p><p class="formulaDsp">
<picture><source srcset="form_151_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
   u^{(m+1)} = \alpha u^{(m)} + (1-\alpha) G * \left(\rho^{(m)}_{\mbox{vol}} + \rho^{(m)}_{\mbox{surf}} \right)
\]" src="form_151.png"/></picture>
</p>
<p> with <picture><source srcset="form_152_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$ \alpha \in [0,1]$" src="form_152.png"/></picture> . This works (for sufficiently small <picture><source srcset="form_153_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\alpha$" src="form_153.png"/></picture>) and is implemented in the code.</p>
<p><a class="el" href="classA.html">A</a> more robust approach is to use a solver that exploits information from previous iterations (the Krylov subspace) to estimate the optimal direction and length of the step to take. Such a solver is provided by <a class="el" href="nonlinsol_8h.html" title="Implementation of Krylov-subspace nonlinear equation solver.">nonlinsol.h</a>. Each iteration we pass the current solution and corresponding residual to the solver and it provides the next trial vector.</p>
<p>In the code you can switch between using the solver or simple iteration by changing the value of <code>USE_SOLVER</code> .</p>
<p>One final point is how to compute the reciprocal of the permittivity. This operation is not provided explicity by MADNESS, in part because even functions that are analytically never zero, might be (nearly) zero due to numerical truncation. Handling this issue correctly is problem specific. More generally, we want to compute a function-of-a-function. If <picture><source srcset="form_154_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$f(r)$" src="form_154.png"/></picture> is a MADNESS function that takes a d-dimensional vector as its argument (in this examaple <picture><source srcset="form_155_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$d=3$" src="form_155.png"/></picture>) and <picture><source srcset="form_156_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$F(x)$" src="form_156.png"/></picture> is computable function that takes a scalar argument, we want to compute the new MADNESS function  </p><p class="formulaDsp">
<picture><source srcset="form_157_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaDsp" alt="\[
    g(r) = F(f(r))
\]" src="form_157.png"/></picture>
</p>
<p> There are various ways to do this. The simplest is employed here &mdash; we define a function (<code><a class="el" href="dielectric_8cc.html#aa92759446c645b9f3114af44019cf750">reciprocal()</a></code> ) that is passed into the <code>unaryop()</code> method that modifies the function <em>in-place</em>. This simple approach is justified here since we know our input function is never zero even due to numerical noise, and the output function is about as smooth as the input. If it were not, we might have to refine the input function to obtain the desired precision. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jan 28 2026 13:36:10 for MADNESS by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
