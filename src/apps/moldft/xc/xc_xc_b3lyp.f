c:XC_B3LYPsubrstart

c    Generated: Thu Feb 13 08:52:41 GMT 2003

      subroutine uks_xc_b3lyp
     & (ideriv,npt,rhoa1,rhob1,sigmaaa1,sigmabb1,sigmaab1,
     &  zk,vrhoa,vrhob,vsigmaaa,vsigmabb,vsigmaab,
     &  v2rhoa2,v2rhob2,v2rhoab,
     &  v2rhoasigmaaa,v2rhoasigmaab,v2rhoasigmabb,
     &  v2rhobsigmabb,v2rhobsigmaab,v2rhobsigmaaa,
     &  v2sigmaaa2,v2sigmaaaab,v2sigmaaabb,
     &  v2sigmaab2,v2sigmaabbb,v2sigmabb2)
c
c     P.J. Stephens, F.J. Devlin, C.F. Chabalowski, M.J. Frisch
c     Ab initio calculation of vibrational absorption and circular 
c     dichroism spectra using density functional force fields
c     J. Phys. Chem. 98 (1994) 11623-11627
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt),rhob1(npt)
      real*8 sigmaaa1(npt),sigmabb1(npt),sigmaab1(npt)
      real*8 zk(npt),vrhoa(npt),vrhob(npt)
      real*8 vsigmaaa(npt),vsigmabb(npt),vsigmaab(npt)
      real*8 v2rhoa2(npt),v2rhob2(npt),v2rhoab(npt)
      real*8 v2rhoasigmaaa(npt),v2rhoasigmaab(npt)
      real*8 v2rhoasigmabb(npt),v2rhobsigmabb(npt)
      real*8 v2rhobsigmaab(npt),v2rhobsigmaaa(npt)
      real*8 v2sigmaaa2(npt),v2sigmaaaab(npt),v2sigmaaabb(npt)
      real*8 v2sigmaab2(npt),v2sigmaabbb(npt),v2sigmabb2(npt)
      parameter(tol=1.0d-20)
      
      if (ideriv.eq.0) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t5 = 1/t3
      t7 = dsqrt(sigmabb)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t16 = 1/rhob
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t22 = 1/(0.6203504908994D0*t17+0.1584942278842832D2*t19
     #+0.101578D3)
      t25 = dlog(0.6203504908994D0*t17*t22)
      t31 = datan(0.1171685277708993D1/(0.1575246635799487D1*t19
     #+0.201231D2))
      t35 = (0.7876233178997433D0*t19+0.743294D0)**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t5*sigmabb/(1.D0
     #+0.252D-1*t8*t9)+0.19D0*rhob*(0.1554535D-1*t25
     #+0.6188180297906063D0*t31+0.2667310007273315D-2*t37)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t5 = 1/t3
      t7 = dsqrt(sigmaaa)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t16 = 1/rhoa
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t22 = 1/(0.6203504908994D0*t17+0.1584942278842832D2*t19
     #+0.101578D3)
      t25 = dlog(0.6203504908994D0*t17*t22)
      t31 = datan(0.1171685277708993D1/(0.1575246635799487D1*t19
     #+0.201231D2))
      t35 = (0.7876233178997433D0*t19+0.743294D0)**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t5*sigmaaa/(1.D0
     #+0.252D-1*t8*t9)+0.19D0*rhoa*(0.1554535D-1*t25
     #+0.6188180297906063D0*t31+0.2667310007273315D-2*t37)
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t7 = 1/t5
      t9 = dsqrt(sigmaaa)
      t10 = t9*t7
      t11 = dlog(t10+dsqrt(1+t10**2))
      t18 = rhob**(1.D0/3.D0)
      t19 = t18*rhob
      t21 = 1/t19
      t23 = dsqrt(sigmabb)
      t24 = t23*t21
      t25 = dlog(t24+dsqrt(1+t24**2))
      t32 = rho**(1.D0/3.D0)
      t33 = 1/t32
      t36 = 1/(1.D0+0.349D0*t33)
      t38 = 1/rho
      t39 = rhob*t38
      t42 = 0.2533D0*t33
      t43 = dexp(-t42)
      t45 = rho**2
      t47 = t32**2
      t51 = rhoa**2
      t52 = t4**2
      t55 = rhob**2
      t56 = t18**2
      t60 = t33*t36
      t82 = 0.6666666666666667D0*t45
      t93 = t38**(1.D0/3.D0)
      t94 = 0.6203504908994D0*t93
      t95 = t38**(1.D0/6.D0)
      t98 = 1/(t94+0.1029581201158544D2*t95+0.427198D2)
      t101 = dlog(0.6203504908994D0*t93*t98)
      t103 = 0.1575246635799487D1*t95
      t107 = datan(0.448998886412873D-1/(t103+0.13072D2))
      t109 = 0.7876233178997433D0*t95
      t111 = (t109+0.409286D0)**2
      t113 = dlog(t111*t98)
      t117 = 1/(t94+0.1584942278842832D2*t95+0.101578D3)
      t120 = dlog(0.6203504908994D0*t93*t117)
      t125 = datan(0.1171685277708993D1/(t103+0.201231D2))
      t128 = (t109+0.743294D0)**2
      t130 = dlog(t128*t117)
      t138 = (rhoa-1.D0*rhob)*t38
      t139 = 1.D0+t138
      t140 = t139**(1.D0/3.D0)
      t143 = 1.D0-1.D0*t138
      t144 = t143**(1.D0/3.D0)
      s1 = -0.74442058907928D0*t5-0.3024D-2*t7*sigmaaa/(1.D0+0.252D-1
     #*t10*t11)-0.74442058907928D0*t19
      s2 = s1-0.3024D-2*t21*sigmabb/(1.D0+0.252D-1*t24*t25)
      zk(i) = s2-0.1593432D0*t36*rhoa*t39-0.52583256D-2*t43*t36/t47
     #/t45/rho*(rhoa*rhob*(0.3646239897876478D2*t52*t51
     #+0.3646239897876478D2*t56*t55+(0.2611111111111111D1
     #-0.9850555555555556D-1*t33-0.1357222222222222D0*t60)*sigma-1.D0*
     #(0.25D1-0.1407222222222222D-1*t33-0.1938888888888889D-1*t60)*
     #(sigmaaa+sigmabb)-0.1111111111111111D0*(t42+0.349D0*t60-11.D0)*
     #(rhoa*t38*sigmaaa+t39*sigmabb))-0.6666666666666667D0*t45*sigma+
     #(t82-1.D0*t51)*sigmabb+(t82-1.D0*t55)*sigmaaa)+0.19D0*rho*
     #(0.310907D-1*t101+0.205219729378375D2*t107+0.4431373767749538D-2
     #*t113+0.1923661050931536D1*(0.1554535D-1*t120
     #+0.6188180297906063D0*t125+0.2667310007273315D-2*t130
     #-0.310907D-1*t101-0.205219729378375D2*t107-0.4431373767749538D-2
     #*t113)*(t140*t139+t144*t143-2.D0))
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t5 = 1/t3
      t6 = t5*sigmabb
      t7 = dsqrt(sigmabb)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t12 = 1.D0+0.252D-1*t8*t9
      t13 = 1/t12
      t16 = 1/rhob
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t21 = 0.6203504908994D0*t17+0.1584942278842832D2*t19+0.101578D3
      t22 = 1/t21
      t25 = dlog(0.6203504908994D0*t17*t22)
      t28 = 0.1575246635799487D1*t19+0.201231D2
      t31 = datan(0.1171685277708993D1/t28)
      t34 = 0.7876233178997433D0*t19+0.743294D0
      t35 = t34**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t6*t13+0.19D0*rhob*
     #(0.1554535D-1*t25+0.6188180297906063D0*t31+0.2667310007273315D-2
     #*t37)
      vrhoa(i) = 0.D0
      t43 = rhob**2
      t45 = 1/t2/t43
      t49 = t12**2
      t50 = 1/t49
      t55 = t2**2
      t60 = 1/t55/t43
      t63 = dsqrt(1.D0+sigmabb*t60)
      t64 = 1/t63
      t74 = t17**2
      t75 = 1/t74
      t77 = 1/t43
      t80 = t21**2
      t81 = 1/t80
      t85 = t19**2
      t86 = t85**2
      t88 = 1/t86/t19
      t89 = t88*t77
      t91 = -0.2067834969664667D0*t75*t77-0.2641570464738054D1*t89
      t99 = t28**2
      t100 = 1/t99
      vrhob(i) = -0.99256078543904D0*t2+0.4032D-2*t45*sigmabb*t13
     #+0.3024D-2*t6*t50*(-0.336D-1*t7*t45*t9-0.336D-1*sigmabb/t55/t43
     #/rhob*t64)+0.29536165D-2*t25+0.1175754256602152D0*t31
     #+0.5067889013819299D-3*t37+0.19D0*rhob*(0.2505897912236993D-1*(
     #-0.2067834969664667D0*t75*t22*t77-0.6203504908994D0*t17*t81*t91)
     #/t17*t21+0.1903580477513215D0*t100*t88*t77/(1.D0+0.137284639D1
     #*t100)+0.2667310007273315D-2*(-0.2625411059665811D0*t34*t22*t89
     #-1.D0*t35*t81*t91)/t35*t21)
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      vsigmabb(i) = -0.3024D-2*t5*t13+0.3024D-2*t6*t50*(0.126D-1/t7*t5
     #*t9+0.126D-1*t60*t64)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t5 = 1/t3
      t6 = t5*sigmaaa
      t7 = dsqrt(sigmaaa)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t12 = 1.D0+0.252D-1*t8*t9
      t13 = 1/t12
      t16 = 1/rhoa
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t21 = 0.6203504908994D0*t17+0.1584942278842832D2*t19+0.101578D3
      t22 = 1/t21
      t25 = dlog(0.6203504908994D0*t17*t22)
      t28 = 0.1575246635799487D1*t19+0.201231D2
      t31 = datan(0.1171685277708993D1/t28)
      t34 = 0.7876233178997433D0*t19+0.743294D0
      t35 = t34**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t6*t13+0.19D0*rhoa*
     #(0.1554535D-1*t25+0.6188180297906063D0*t31+0.2667310007273315D-2
     #*t37)
      t43 = rhoa**2
      t45 = 1/t2/t43
      t49 = t12**2
      t50 = 1/t49
      t55 = t2**2
      t60 = 1/t55/t43
      t63 = dsqrt(1.D0+sigmaaa*t60)
      t64 = 1/t63
      t74 = t17**2
      t75 = 1/t74
      t77 = 1/t43
      t80 = t21**2
      t81 = 1/t80
      t85 = t19**2
      t86 = t85**2
      t88 = 1/t86/t19
      t89 = t88*t77
      t91 = -0.2067834969664667D0*t75*t77-0.2641570464738054D1*t89
      t99 = t28**2
      t100 = 1/t99
      vrhoa(i) = -0.99256078543904D0*t2+0.4032D-2*t45*sigmaaa*t13
     #+0.3024D-2*t6*t50*(-0.336D-1*t7*t45*t9-0.336D-1*sigmaaa/t55/t43
     #/rhoa*t64)+0.29536165D-2*t25+0.1175754256602152D0*t31
     #+0.5067889013819299D-3*t37+0.19D0*rhoa*(0.2505897912236993D-1*(
     #-0.2067834969664667D0*t75*t22*t77-0.6203504908994D0*t17*t81*t91)
     #/t17*t21+0.1903580477513215D0*t100*t88*t77/(1.D0+0.137284639D1
     #*t100)+0.2667310007273315D-2*(-0.2625411059665811D0*t34*t22*t89
     #-1.D0*t35*t81*t91)/t35*t21)
      vrhob(i) = 0.D0
      vsigmaaa(i) = -0.3024D-2*t5*t13+0.3024D-2*t6*t50*(0.126D-1/t7*t5
     #*t9+0.126D-1*t60*t64)
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t7 = 1/t5
      t8 = t7*sigmaaa
      t9 = dsqrt(sigmaaa)
      t10 = t9*t7
      t11 = dlog(t10+dsqrt(1+t10**2))
      t14 = 1.D0+0.252D-1*t10*t11
      t15 = 1/t14
      t18 = rhob**(1.D0/3.D0)
      t19 = t18*rhob
      t21 = 1/t19
      t22 = t21*sigmabb
      t23 = dsqrt(sigmabb)
      t24 = t23*t21
      t25 = dlog(t24+dsqrt(1+t24**2))
      t28 = 1.D0+0.252D-1*t24*t25
      t29 = 1/t28
      t32 = rho**(1.D0/3.D0)
      t33 = 1/t32
      t35 = 1.D0+0.349D0*t33
      t36 = 1/t35
      t37 = t36*rhoa
      t38 = 1/rho
      t39 = rhob*t38
      t42 = 0.2533D0*t33
      t43 = dexp(-t42)
      t44 = t43*t36
      t45 = rho**2
      t47 = t32**2
      t49 = 1/t47/t45/rho
      t50 = rhoa*rhob
      t51 = rhoa**2
      t52 = t4**2
      t53 = t52*t51
      t55 = rhob**2
      t56 = t18**2
      t57 = t56*t55
      t60 = t33*t36
      t62 = 0.2611111111111111D1-0.9850555555555556D-1*t33
     #-0.1357222222222222D0*t60
      t67 = sigmaaa+sigmabb
      t71 = t42+0.349D0*t60-11.D0
      t75 = rhoa*t38*sigmaaa+t39*sigmabb
      t78 = 0.3646239897876478D2*t53+0.3646239897876478D2*t57+t62
     #*sigma-1.D0*(0.25D1-0.1407222222222222D-1*t33
     #-0.1938888888888889D-1*t60)*t67-0.1111111111111111D0*t71*t75
      t82 = 0.6666666666666667D0*t45
      t83 = 1.D0*t51
      t86 = 1.D0*t55
      t89 = t50*t78-0.6666666666666667D0*t45*sigma+(t82-t83)*sigmabb+
     #(t82-t86)*sigmaaa
      t93 = t38**(1.D0/3.D0)
      t94 = 0.6203504908994D0*t93
      t95 = t38**(1.D0/6.D0)
      t97 = t94+0.1029581201158544D2*t95+0.427198D2
      t98 = 1/t97
      t101 = dlog(0.6203504908994D0*t93*t98)
      t103 = 0.1575246635799487D1*t95
      t104 = t103+0.13072D2
      t107 = datan(0.448998886412873D-1/t104)
      t109 = 0.7876233178997433D0*t95
      t110 = t109+0.409286D0
      t111 = t110**2
      t113 = dlog(t111*t98)
      t116 = t94+0.1584942278842832D2*t95+0.101578D3
      t117 = 1/t116
      t120 = dlog(0.6203504908994D0*t93*t117)
      t122 = t103+0.201231D2
      t125 = datan(0.1171685277708993D1/t122)
      t127 = t109+0.743294D0
      t128 = t127**2
      t130 = dlog(t128*t117)
      t135 = 0.1554535D-1*t120+0.6188180297906063D0*t125
     #+0.2667310007273315D-2*t130-0.310907D-1*t101-0.205219729378375D2
     #*t107-0.4431373767749538D-2*t113
      t137 = rhoa-1.D0*rhob
      t138 = t137*t38
      t139 = 1.D0+t138
      t140 = t139**(1.D0/3.D0)
      t143 = 1.D0-1.D0*t138
      t144 = t143**(1.D0/3.D0)
      t146 = t140*t139+t144*t143-2.D0
      t147 = t135*t146
      zk(i) = -0.74442058907928D0*t5-0.3024D-2*t8*t15
     #-0.74442058907928D0*t19-0.3024D-2*t22*t29-0.1593432D0*t37*t39
     #-0.52583256D-2*t44*t49*t89+0.19D0*rho*(0.310907D-1*t101
     #+0.205219729378375D2*t107+0.4431373767749538D-2*t113
     #+0.1923661050931536D1*t147)
      t154 = 1/t4/t51
      t158 = t14**2
      t159 = 1/t158
      t167 = 1/t53
      t170 = dsqrt(1.D0+sigmaaa*t167)
      t171 = 1/t170
      t184 = t71*t38
      t195 = rho*t135
      t200 = 0.1333333333333333D1*t140*t38-0.1333333333333333D1*t144*t38
      t203 = t35**2
      t204 = 1/t203
      t210 = 0.185369256D-1*t204*rhoa*rhob/t32/t45
      t211 = 1/t45
      t212 = rhob*t211
      t214 = 0.1593432D0*t37*t212
      t215 = t45**2
      t217 = 1/t215/rho
      t221 = 0.44397795816D-3*t217*t43*t36*t89
      t225 = 0.6117185448D-3*t43*t204*t217*t89
      t230 = 0.192805272D-1*t44/t47/t215*t89
      t232 = 1/t32/rho
      t234 = t232*t36
      t238 = 1/t47/rho*t204
      t273 = 0.52583256D-2*t44*t49*(t50*((0.3283518518518519D-1*t232
     #+0.4524074074074074D-1*t234-0.1578901851851852D-1*t238)*sigma
     #-1.D0*(0.4690740740740741D-2*t232+0.6462962962962963D-2*t234
     #-0.2255574074074074D-2*t238)*t67-0.1111111111111111D0*(
     #-0.8443333333333333D-1*t232-0.1163333333333333D0*t234
     #+0.4060033333333333D-1*t238)*t75-0.1111111111111111D0*t71*(-1.D0
     #*rhoa*t211*sigmaaa-1.D0*t212*sigmabb))-0.1333333333333333D1*rho
     #*sigma+0.1333333333333333D1*rho*sigmabb+0.1333333333333333D1*rho
     #*sigmaaa)
      t274 = 0.5907233D-2*t101
      t275 = 0.3899174858189126D1*t107
      t276 = 0.8419610158724123D-3*t113
      t277 = 0.3654955996769919D0*t147
      t278 = t93**2
      t279 = 1/t278
      t283 = t97**2
      t284 = 1/t283
      t287 = 0.2067834969664667D0*t279*t211
      t288 = t95**2
      t289 = t288**2
      t291 = 1/t289/t95
      t292 = t291*t211
      t294 = -t287-0.1715968668597574D1*t292
      t298 = 1/t93
      t300 = (-0.2067834969664667D0*t279*t98*t211-0.6203504908994D0
     #*t93*t284*t294)*t298*t97
      t302 = t104**2
      t303 = 1/t302
      t309 = t303*t291*t211/(1.D0+0.2016D-2*t303)
      t320 = (-0.2625411059665811D0*t110*t98*t292-1.D0*t111*t284*t294)
     #/t111*t97
      t325 = t116**2
      t326 = 1/t325
      t329 = -t287-0.2641570464738054D1*t292
      t336 = t122**2
      t337 = 1/t336
      t373 = 0.19D0*rho*(0.5011795824473985D-1*t300
     #+0.2419143800947354D0*t309+0.4431373767749538D-2*t320
     #+0.1923661050931536D1*(0.2505897912236993D-1*(
     #-0.2067834969664667D0*t279*t117*t211-0.6203504908994D0*t93*t326
     #*t329)*t298*t116+0.1903580477513215D0*t337*t291*t211/(1.D0
     #+0.137284639D1*t337)+0.2667310007273315D-2*(
     #-0.2625411059665811D0*t127*t117*t292-1.D0*t128*t326*t329)/t128
     #*t116-0.5011795824473985D-1*t300-0.2419143800947354D0*t309
     #-0.4431373767749538D-2*t320)*t146+0.1923661050931536D1*t135*(
     #-0.1333333333333333D1*t140*t137*t211+0.1333333333333333D1*t144
     #*t137*t211))
      vrhoa(i) = -0.99256078543904D0*t4+0.4032D-2*t154*sigmaaa*t15
     #+0.3024D-2*t8*t159*(-0.336D-1*t9*t154*t11-0.336D-1*sigmaaa/t52
     #/t51/rhoa*t171)-0.1593432D0*t36*rhob*t38-0.52583256D-2*t44*t49*
     #(rhob*t78+t50*(0.9723306394337274D2*t52*rhoa
     #-0.1111111111111111D0*t184*sigmaaa)-2.D0*rhoa*sigmabb)
     #+0.3654955996769919D0*t195*t200-t210+t214-t221-t225+t230-t273
     #+t274+t275+t276+t277+t373
      t376 = 1/t18/t55
      t380 = t28**2
      t381 = 1/t380
      t389 = 1/t57
      t392 = dsqrt(1.D0+sigmabb*t389)
      t393 = 1/t392
      vrhob(i) = -0.99256078543904D0*t18+0.4032D-2*t376*sigmabb*t29
     #+0.3024D-2*t22*t381*(-0.336D-1*t23*t376*t25-0.336D-1*sigmabb/t56
     #/t55/rhob*t393)-0.1593432D0*t37*t38-0.52583256D-2*t44*t49*(rhoa
     #*t78+t50*(0.9723306394337274D2*t56*rhob-0.1111111111111111D0
     #*t184*sigmabb)-2.D0*rhob*sigmaaa)-0.3654955996769919D0*t195*t200
     #-t210+t214-t221-t225+t230-t273+t274+t275+t276+t277+t373
      t430 = 0.1407222222222222D-1*t33
      t431 = 0.1938888888888889D-1*t60
      t445 = t44*t49*(t50*t62-0.6666666666666667D0*t45)
      t446 = 0.52583256D-2*t445
      vsigmaaa(i) = -0.3024D-2*t7*t15+0.3024D-2*t8*t159*(0.126D-1/t9
     #*t7*t11+0.126D-1*t167*t171)-0.52583256D-2*t44*t49*(t50*(-0.25D1
     #+t430+t431-0.1111111111111111D0*t71*rhoa*t38)+t82-t86)-t446
      vsigmaab(i) = -0.105166512D-1*t445
      vsigmabb(i) = -0.3024D-2*t21*t29+0.3024D-2*t22*t381*(0.126D-1
     #/t23*t21*t25+0.126D-1*t389*t393)-0.52583256D-2*t44*t49*(t50*(
     #-0.25D1+t430+t431-0.1111111111111111D0*t71*rhob*t38)+t82-t83)-t446
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t5 = 1/t3
      t6 = t5*sigmabb
      t7 = dsqrt(sigmabb)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t12 = 1.D0+0.252D-1*t8*t9
      t13 = 1/t12
      t16 = 1/rhob
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t21 = 0.6203504908994D0*t17+0.1584942278842832D2*t19+0.101578D3
      t22 = 1/t21
      t25 = dlog(0.6203504908994D0*t17*t22)
      t28 = 0.1575246635799487D1*t19+0.201231D2
      t31 = datan(0.1171685277708993D1/t28)
      t34 = 0.7876233178997433D0*t19+0.743294D0
      t35 = t34**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t6*t13+0.19D0*rhob*
     #(0.1554535D-1*t25+0.6188180297906063D0*t31+0.2667310007273315D-2
     #*t37)
      vrhoa(i) = 0.D0
      t43 = rhob**2
      t45 = 1/t2/t43
      t46 = t45*sigmabb
      t49 = t12**2
      t50 = 1/t49
      t54 = t43*rhob
      t55 = t2**2
      t60 = 1/t55/t43
      t62 = 1.D0+sigmabb*t60
      t63 = dsqrt(t62)
      t64 = 1/t63
      t67 = -0.336D-1*t7*t45*t9-0.336D-1*sigmabb/t55/t54*t64
      t68 = t50*t67
      t74 = t17**2
      t75 = 1/t74
      t76 = t75*t22
      t77 = 1/t43
      t80 = t21**2
      t81 = 1/t80
      t82 = t17*t81
      t85 = t19**2
      t86 = t85**2
      t87 = t86*t19
      t88 = 1/t87
      t89 = t88*t77
      t91 = -0.2067834969664667D0*t75*t77-0.2641570464738054D1*t89
      t94 = -0.2067834969664667D0*t76*t77-0.6203504908994D0*t82*t91
      t95 = 1/t17
      t96 = t94*t95
      t97 = t96*t21
      t99 = t28**2
      t100 = 1/t99
      t101 = t100*t88
      t103 = 1.D0+0.137284639D1*t100
      t104 = 1/t103
      t106 = t101*t77*t104
      t108 = t34*t22
      t111 = t35*t81
      t114 = -0.2625411059665811D0*t108*t89-1.D0*t111*t91
      t115 = 1/t35
      t116 = t114*t115
      t117 = t116*t21
      vrhob(i) = -0.99256078543904D0*t2+0.4032D-2*t46*t13+0.3024D-2*t6
     #*t68+0.29536165D-2*t25+0.1175754256602152D0*t31
     #+0.5067889013819299D-3*t37+0.19D0*rhob*(0.2505897912236993D-1
     #*t97+0.1903580477513215D0*t106+0.2667310007273315D-2*t117)
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      t130 = 0.126D-1/t7*t5*t9+0.126D-1*t60*t64
      vsigmabb(i) = -0.3024D-2*t5*t13+0.3024D-2*t6*t50*t130
      v2rhoa2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t137 = 1/t2/t54
      t144 = 1/t49/t12
      t145 = t67**2
      t152 = t43**2
      t158 = sigmabb**2
      t164 = 1/t63/t62
      t175 = 1/t74/t16
      t177 = 1/t152
      t178 = t175*t22*t177
      t184 = 1/t54
      t188 = 1/t80/t21
      t190 = t91**2
      t198 = 1/t87/t16
      t199 = t198*t177
      t201 = t88*t184
      t203 = -0.1378556646443111D0*t175*t177+0.4135669939329333D0*t75
     #*t184-0.2201308720615045D1*t199+0.5283140929476108D1*t201
      t221 = t177*t104
      t230 = t99**2
      t234 = t103**2
      s1 = -0.3308535951463467D0/t55-0.9408D-2*t137*sigmabb*t13
     #-0.8064D-2*t46*t68-0.6048D-2*t6*t144*t145
      s2 = s1+0.3024D-2*t6*t50*(0.784D-1*t7*t137*t9+0.168D0*sigmabb
     #/t55/t152*t64-0.448D-1*t158/t2/t152/t54*t164)
     #+0.9522412066500572D-2*t97
      s3 = s2+0.7233605814550218D-1*t106
      s4 = s3
      s5 = 0.101357780276386D-2*t117+0.19D0*rhob*
     #(0.2505897912236993D-1*(-0.1378556646443111D0*t178
     #+0.4135669939329333D0*t75*t81*t77*t91+0.4135669939329333D0*t76
     #*t184+0.12407009817988D1*t17*t188*t190-0.6203504908994D0*t82
     #*t203)*t95*t21+0.8352993040789975D-2*t94/t17/t16*t21*t77
     #+0.2505897912236993D-1*t96*t91+0.9995362477254242D-1/t99/t28
     #*t175*t221+0.1586317064594346D0*t100*t198*t221
     #-0.3807160955026431D0*t101*t184*t104-0.1372209729363994D0/t230
     #/t28*t175*t177/t234+0.2667310007273315D-2*(0.3446391616107778D-1
     #*t178+0.5250822119331622D0*t34*t81*t89*t91-0.2187842549721509D0
     #*t108*t199+0.5250822119331622D0*t108*t201+2.D0*t35*t188*t190
     #-1.D0*t111*t203)*t115*t21+0.7002785192652656D-3*t114/t35/t34*t21
     #*t88*t77+0.2667310007273315D-2*t116*t91)
      v2rhob2(i) = s4+s5
      v2sigmaaa2(i) = 0.D0
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t272 = t130**2
      v2sigmabb2(i) = 0.6048D-2*t5*t50*t130-0.6048D-2*t6*t144*t272
     #+0.3024D-2*t6*t50*(-0.63D-2/t7/sigmabb*t5*t9+0.63D-2/sigmabb*t60
     #*t64-0.63D-2/t2/t152/rhob*t164)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t5 = 1/t3
      t6 = t5*sigmaaa
      t7 = dsqrt(sigmaaa)
      t8 = t7*t5
      t9 = dlog(t8+dsqrt(1+t8**2))
      t12 = 1.D0+0.252D-1*t8*t9
      t13 = 1/t12
      t16 = 1/rhoa
      t17 = t16**(1.D0/3.D0)
      t19 = t16**(1.D0/6.D0)
      t21 = 0.6203504908994D0*t17+0.1584942278842832D2*t19+0.101578D3
      t22 = 1/t21
      t25 = dlog(0.6203504908994D0*t17*t22)
      t28 = 0.1575246635799487D1*t19+0.201231D2
      t31 = datan(0.1171685277708993D1/t28)
      t34 = 0.7876233178997433D0*t19+0.743294D0
      t35 = t34**2
      t37 = dlog(t35*t22)
      zk(i) = -0.74442058907928D0*t3-0.3024D-2*t6*t13+0.19D0*rhoa*
     #(0.1554535D-1*t25+0.6188180297906063D0*t31+0.2667310007273315D-2
     #*t37)
      t43 = rhoa**2
      t45 = 1/t2/t43
      t46 = t45*sigmaaa
      t49 = t12**2
      t50 = 1/t49
      t54 = t43*rhoa
      t55 = t2**2
      t60 = 1/t55/t43
      t62 = 1.D0+sigmaaa*t60
      t63 = dsqrt(t62)
      t64 = 1/t63
      t67 = -0.336D-1*t7*t45*t9-0.336D-1*sigmaaa/t55/t54*t64
      t68 = t50*t67
      t74 = t17**2
      t75 = 1/t74
      t76 = t75*t22
      t77 = 1/t43
      t80 = t21**2
      t81 = 1/t80
      t82 = t17*t81
      t85 = t19**2
      t86 = t85**2
      t87 = t86*t19
      t88 = 1/t87
      t89 = t88*t77
      t91 = -0.2067834969664667D0*t75*t77-0.2641570464738054D1*t89
      t94 = -0.2067834969664667D0*t76*t77-0.6203504908994D0*t82*t91
      t95 = 1/t17
      t96 = t94*t95
      t97 = t96*t21
      t99 = t28**2
      t100 = 1/t99
      t101 = t100*t88
      t103 = 1.D0+0.137284639D1*t100
      t104 = 1/t103
      t106 = t101*t77*t104
      t108 = t34*t22
      t111 = t35*t81
      t114 = -0.2625411059665811D0*t108*t89-1.D0*t111*t91
      t115 = 1/t35
      t116 = t114*t115
      t117 = t116*t21
      vrhoa(i) = -0.99256078543904D0*t2+0.4032D-2*t46*t13+0.3024D-2*t6
     #*t68+0.29536165D-2*t25+0.1175754256602152D0*t31
     #+0.5067889013819299D-3*t37+0.19D0*rhoa*(0.2505897912236993D-1
     #*t97+0.1903580477513215D0*t106+0.2667310007273315D-2*t117)
      vrhob(i) = 0.D0
      t130 = 0.126D-1/t7*t5*t9+0.126D-1*t60*t64
      vsigmaaa(i) = -0.3024D-2*t5*t13+0.3024D-2*t6*t50*t130
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      t137 = 1/t2/t54
      t144 = 1/t49/t12
      t145 = t67**2
      t152 = t43**2
      t158 = sigmaaa**2
      t164 = 1/t63/t62
      t175 = 1/t74/t16
      t177 = 1/t152
      t178 = t175*t22*t177
      t184 = 1/t54
      t188 = 1/t80/t21
      t190 = t91**2
      t198 = 1/t87/t16
      t199 = t198*t177
      t201 = t88*t184
      t203 = -0.1378556646443111D0*t175*t177+0.4135669939329333D0*t75
     #*t184-0.2201308720615045D1*t199+0.5283140929476108D1*t201
      t221 = t177*t104
      t230 = t99**2
      t234 = t103**2
      s1 = -0.3308535951463467D0/t55-0.9408D-2*t137*sigmaaa*t13
     #-0.8064D-2*t46*t68-0.6048D-2*t6*t144*t145
      s2 = s1+0.3024D-2*t6*t50*(0.784D-1*t7*t137*t9+0.168D0*sigmaaa
     #/t55/t152*t64-0.448D-1*t158/t2/t152/t54*t164)
     #+0.9522412066500572D-2*t97
      s3 = s2+0.7233605814550218D-1*t106
      s4 = s3
      s5 = 0.101357780276386D-2*t117+0.19D0*rhoa*
     #(0.2505897912236993D-1*(-0.1378556646443111D0*t178
     #+0.4135669939329333D0*t75*t81*t77*t91+0.4135669939329333D0*t76
     #*t184+0.12407009817988D1*t17*t188*t190-0.6203504908994D0*t82
     #*t203)*t95*t21+0.8352993040789975D-2*t94/t17/t16*t21*t77
     #+0.2505897912236993D-1*t96*t91+0.9995362477254242D-1/t99/t28
     #*t175*t221+0.1586317064594346D0*t100*t198*t221
     #-0.3807160955026431D0*t101*t184*t104-0.1372209729363994D0/t230
     #/t28*t175*t177/t234+0.2667310007273315D-2*(0.3446391616107778D-1
     #*t178+0.5250822119331622D0*t34*t81*t89*t91-0.2187842549721509D0
     #*t108*t199+0.5250822119331622D0*t108*t201+2.D0*t35*t188*t190
     #-1.D0*t111*t203)*t115*t21+0.7002785192652656D-3*t114/t35/t34*t21
     #*t88*t77+0.2667310007273315D-2*t116*t91)
      v2rhoa2(i) = s4+s5
      v2rhob2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t272 = t130**2
      v2sigmaaa2(i) = 0.6048D-2*t5*t50*t130-0.6048D-2*t6*t144*t272
     #+0.3024D-2*t6*t50*(-0.63D-2/t7/sigmaaa*t5*t9+0.63D-2/sigmaaa*t60
     #*t64-0.63D-2/t2/t152/rhoa*t164)
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      v2sigmabb2(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t7 = 1/t5
      t8 = t7*sigmaaa
      t9 = dsqrt(sigmaaa)
      t10 = t9*t7
      t11 = dlog(t10+dsqrt(1+t10**2))
      t14 = 1.D0+0.252D-1*t10*t11
      t15 = 1/t14
      t18 = rhob**(1.D0/3.D0)
      t19 = t18*rhob
      t21 = 1/t19
      t22 = t21*sigmabb
      t23 = dsqrt(sigmabb)
      t24 = t23*t21
      t25 = dlog(t24+dsqrt(1+t24**2))
      t28 = 1.D0+0.252D-1*t24*t25
      t29 = 1/t28
      t32 = rho**(1.D0/3.D0)
      t33 = 1/t32
      t35 = 1.D0+0.349D0*t33
      t36 = 1/t35
      t37 = t36*rhoa
      t38 = 1/rho
      t39 = rhob*t38
      t42 = 0.2533D0*t33
      t43 = dexp(-t42)
      t44 = t43*t36
      t45 = rho**2
      t46 = t45*rho
      t47 = t32**2
      t49 = 1/t47/t46
      t50 = rhoa*rhob
      t51 = rhoa**2
      t52 = t4**2
      t53 = t52*t51
      t54 = 0.3646239897876478D2*t53
      t55 = rhob**2
      t56 = t18**2
      t57 = t56*t55
      t58 = 0.3646239897876478D2*t57
      t60 = t33*t36
      t62 = 0.2611111111111111D1-0.9850555555555556D-1*t33
     #-0.1357222222222222D0*t60
      t63 = t62*sigma
      t67 = sigmaaa+sigmabb
      t69 = 1.D0*(0.25D1-0.1407222222222222D-1*t33
     #-0.1938888888888889D-1*t60)*t67
      t71 = t42+0.349D0*t60-11.D0
      t75 = rhoa*t38*sigmaaa+t39*sigmabb
      t77 = 0.1111111111111111D0*t71*t75
      t78 = t54+t58+t63-t69-t77
      t82 = 0.6666666666666667D0*t45
      t83 = 1.D0*t51
      t86 = 1.D0*t55
      t89 = t50*t78-0.6666666666666667D0*t45*sigma+(t82-t83)*sigmabb+
     #(t82-t86)*sigmaaa
      t93 = t38**(1.D0/3.D0)
      t94 = 0.6203504908994D0*t93
      t95 = t38**(1.D0/6.D0)
      t97 = t94+0.1029581201158544D2*t95+0.427198D2
      t98 = 1/t97
      t101 = dlog(0.6203504908994D0*t93*t98)
      t103 = 0.1575246635799487D1*t95
      t104 = t103+0.13072D2
      t107 = datan(0.448998886412873D-1/t104)
      t109 = 0.7876233178997433D0*t95
      t110 = t109+0.409286D0
      t111 = t110**2
      t113 = dlog(t111*t98)
      t116 = t94+0.1584942278842832D2*t95+0.101578D3
      t117 = 1/t116
      t120 = dlog(0.6203504908994D0*t93*t117)
      t122 = t103+0.201231D2
      t125 = datan(0.1171685277708993D1/t122)
      t127 = t109+0.743294D0
      t128 = t127**2
      t130 = dlog(t128*t117)
      t135 = 0.1554535D-1*t120+0.6188180297906063D0*t125
     #+0.2667310007273315D-2*t130-0.310907D-1*t101-0.205219729378375D2
     #*t107-0.4431373767749538D-2*t113
      t137 = rhoa-1.D0*rhob
      t138 = t137*t38
      t139 = 1.D0+t138
      t140 = t139**(1.D0/3.D0)
      t143 = 1.D0-1.D0*t138
      t144 = t143**(1.D0/3.D0)
      t146 = t140*t139+t144*t143-2.D0
      t147 = t135*t146
      zk(i) = -0.74442058907928D0*t5-0.3024D-2*t8*t15
     #-0.74442058907928D0*t19-0.3024D-2*t22*t29-0.1593432D0*t37*t39
     #-0.52583256D-2*t44*t49*t89+0.19D0*rho*(0.310907D-1*t101
     #+0.205219729378375D2*t107+0.4431373767749538D-2*t113
     #+0.1923661050931536D1*t147)
      t154 = 1/t4/t51
      t155 = t154*sigmaaa
      t158 = t14**2
      t159 = 1/t158
      t163 = t51*rhoa
      t165 = 1/t52/t163
      t167 = 1/t53
      t169 = 1.D0+sigmaaa*t167
      t170 = dsqrt(t169)
      t171 = 1/t170
      t174 = -0.336D-1*t9*t154*t11-0.336D-1*sigmaaa*t165*t171
      t175 = t159*t174
      t178 = t36*rhob
      t182 = t52*rhoa
      t184 = t71*t38
      t187 = 0.9723306394337274D2*t182-0.1111111111111111D0*t184*sigmaaa
      t191 = rhob*t78+t50*t187-2.D0*rhoa*sigmabb
      t195 = rho*t135
      t200 = 0.1333333333333333D1*t140*t38-0.1333333333333333D1*t144*t38
      t203 = t35**2
      t204 = 1/t203
      t205 = t204*rhoa
      t207 = 1/t32/t45
      t210 = 0.185369256D-1*t205*rhob*t207
      t211 = 1/t45
      t212 = rhob*t211
      t214 = 0.1593432D0*t37*t212
      t215 = t45**2
      t216 = t215*rho
      t217 = 1/t216
      t218 = t217*t43
      t219 = t36*t89
      t221 = 0.44397795816D-3*t218*t219
      t222 = t43*t204
      t225 = 0.6117185448D-3*t222*t217*t89
      t227 = 1/t47/t215
      t230 = 0.192805272D-1*t44*t227*t89
      t232 = 1/t32/rho
      t234 = t232*t36
      t238 = 1/t47/rho*t204
      t240 = 0.3283518518518519D-1*t232+0.4524074074074074D-1*t234
     #-0.1578901851851852D-1*t238
      t251 = -0.8443333333333333D-1*t232-0.1163333333333333D0*t234
     #+0.4060033333333333D-1*t238
      t259 = -1.D0*rhoa*t211*sigmaaa-1.D0*t212*sigmabb
      t262 = t240*sigma-1.D0*(0.4690740740740741D-2*t232
     #+0.6462962962962963D-2*t234-0.2255574074074074D-2*t238)*t67
     #-0.1111111111111111D0*t251*t75-0.1111111111111111D0*t71*t259
      t270 = t50*t262-0.1333333333333333D1*rho*sigma
     #+0.1333333333333333D1*rho*sigmabb+0.1333333333333333D1*rho*sigmaaa
      t273 = 0.52583256D-2*t44*t49*t270
      t274 = 0.5907233D-2*t101
      t275 = 0.3899174858189126D1*t107
      t276 = 0.8419610158724123D-3*t113
      t277 = 0.3654955996769919D0*t147
      t278 = t93**2
      t279 = 1/t278
      t280 = t279*t98
      t283 = t97**2
      t284 = 1/t283
      t285 = t93*t284
      t287 = 0.2067834969664667D0*t279*t211
      t288 = t95**2
      t289 = t288**2
      t290 = t289*t95
      t291 = 1/t290
      t292 = t291*t211
      t294 = -t287-0.1715968668597574D1*t292
      t297 = -0.2067834969664667D0*t280*t211-0.6203504908994D0*t285*t294
      t298 = 1/t93
      t299 = t297*t298
      t300 = t299*t97
      t302 = t104**2
      t303 = 1/t302
      t304 = t303*t291
      t306 = 1.D0+0.2016D-2*t303
      t307 = 1/t306
      t309 = t304*t211*t307
      t311 = t110*t98
      t314 = t111*t284
      t317 = -0.2625411059665811D0*t311*t292-1.D0*t314*t294
      t318 = 1/t111
      t319 = t317*t318
      t320 = t319*t97
      t322 = t279*t117
      t325 = t116**2
      t326 = 1/t325
      t327 = t93*t326
      t329 = -t287-0.2641570464738054D1*t292
      t332 = -0.2067834969664667D0*t322*t211-0.6203504908994D0*t327*t329
      t333 = t332*t298
      t336 = t122**2
      t337 = 1/t336
      t338 = t337*t291
      t340 = 1.D0+0.137284639D1*t337
      t341 = 1/t340
      t345 = t127*t117
      t348 = t128*t326
      t351 = -0.2625411059665811D0*t345*t292-1.D0*t348*t329
      t352 = 1/t128
      t353 = t351*t352
      t359 = 0.2505897912236993D-1*t333*t116+0.1903580477513215D0*t338
     #*t211*t341+0.2667310007273315D-2*t353*t116-0.5011795824473985D-1
     #*t300-0.2419143800947354D0*t309-0.4431373767749538D-2*t320
      t360 = t359*t146
      t362 = t140*t137
      t365 = t144*t137
      t368 = -0.1333333333333333D1*t362*t211+0.1333333333333333D1*t365
     #*t211
      t369 = t135*t368
      t373 = 0.19D0*rho*(0.5011795824473985D-1*t300
     #+0.2419143800947354D0*t309+0.4431373767749538D-2*t320
     #+0.1923661050931536D1*t360+0.1923661050931536D1*t369)
      vrhoa(i) = -0.99256078543904D0*t4+0.4032D-2*t155*t15+0.3024D-2
     #*t8*t175-0.1593432D0*t178*t38-0.52583256D-2*t44*t49*t191
     #+0.3654955996769919D0*t195*t200-t210+t214-t221-t225+t230-t273
     #+t274+t275+t276+t277+t373
      t376 = 1/t18/t55
      t377 = t376*sigmabb
      t380 = t28**2
      t381 = 1/t380
      t385 = t55*rhob
      t387 = 1/t56/t385
      t389 = 1/t57
      t391 = 1.D0+sigmabb*t389
      t392 = dsqrt(t391)
      t393 = 1/t392
      t396 = -0.336D-1*t23*t376*t25-0.336D-1*sigmabb*t387*t393
      t397 = t381*t396
      t403 = t56*rhob
      t407 = 0.9723306394337274D2*t403-0.1111111111111111D0*t184*sigmabb
      t411 = rhoa*t78+t50*t407-2.D0*rhob*sigmaaa
      t415 = -t200
      vrhob(i) = -0.99256078543904D0*t18+0.4032D-2*t377*t29+0.3024D-2
     #*t22*t397-0.1593432D0*t37*t38-0.52583256D-2*t44*t49*t411
     #+0.3654955996769919D0*t195*t415-t210+t214-t221-t225+t230-t273
     #+t274+t275+t276+t277+t373
      t420 = 1/t9
      t426 = 0.126D-1*t420*t7*t11+0.126D-1*t167*t171
      t427 = t159*t426
      t430 = 0.1407222222222222D-1*t33
      t431 = 0.1938888888888889D-1*t60
      t432 = t71*rhoa
      t435 = -0.25D1+t430+t431-0.1111111111111111D0*t432*t38
      t437 = t50*t435+t82-t86
      t443 = t50*t62-0.6666666666666667D0*t45
      t445 = t44*t49*t443
      t446 = 0.52583256D-2*t445
      vsigmaaa(i) = -0.3024D-2*t7*t15+0.3024D-2*t8*t427-0.52583256D-2
     #*t44*t49*t437-t446
      vsigmaab(i) = -0.105166512D-1*t445
      t450 = 1/t23
      t456 = 0.126D-1*t450*t21*t25+0.126D-1*t389*t393
      t457 = t381*t456
      t460 = t71*rhob
      t463 = -0.25D1+t430+t431-0.1111111111111111D0*t460*t38
      t465 = t50*t463+t82-t83
      vsigmabb(i) = -0.3024D-2*t21*t29+0.3024D-2*t22*t457
     #-0.52583256D-2*t44*t49*t465-t446
      t469 = 0.9192746443599945D-1*t309
      t470 = 0.1904482413300114D-1*t300
      t471 = 0.1683922031744825D-2*t320
      t472 = 0.7309911993539838D0*t360
      t473 = 0.7309911993539838D0*t369
      t478 = 0.899757936D-1*t44/t47/t216*t89
      t483 = 0.61789752D-1*t205*rhob/t32/t46
      t484 = t215*t45
      t485 = 1/t484
      t488 = 0.53015607216D-2*t222*t485*t89
      t490 = 1/t32/t484
      t491 = t490*t43
      t494 = 0.10329887159856D-3*t491*t204*t89
      t497 = 0.385610544D-1*t44*t227*t270
      t500 = 0.12234370896D-2*t222*t217*t270
      t501 = 1/t46
      t502 = rhob*t501
      t503 = t37*t502
      t504 = 0.3186864D0*t503
      t506 = t207*t36
      t510 = 1/t47/t45*t204
      t513 = 1/t203/t35
      t514 = t501*t513
      t549 = t44*t49*(t50*((-0.4378024691358025D-1*t207
     #-0.6032098765432099D-1*t506+0.3157803703703704D-1*t510
     #-0.3673578308641975D-2*t514)*sigma-1.D0*(-0.6254320987654321D-2
     #*t207-0.8617283950617284D-2*t506+0.4511148148148148D-2*t510
     #-0.5247969012345679D-3*t514)*t67-0.1111111111111111D0*
     #(0.1125777777777778D0*t207+0.1551111111111111D0*t506
     #-0.8120066666666667D-1*t510+0.9446344222222222D-2*t514)*t75
     #-0.2222222222222222D0*t251*t259-0.1111111111111111D0*t71*(2.D0
     #*rhoa*t501*sigmaaa+2.D0*t502*sigmabb))-0.1333333333333333D1
     #*sigma+0.1333333333333333D1*sigmabb+0.1333333333333333D1*sigmaaa)
      t550 = 0.52583256D-2*t549
      t553 = 0.88795591632D-3*t218*t36*t270
      t555 = 0.37486538933976D-4*t491*t219
      t559 = 1/t158/t14
      t560 = t174**2
      t565 = 1/t4/t163
      t569 = t51**2
      t575 = sigmaaa**2
      t581 = 1/t170/t169
      t588 = t469+t470+t471+t472+t473-t478+t483+t488-t494+t497-t500
     #-t504-t550-t553-t555-0.8064D-2*t155*t175-0.6048D-2*t8*t559*t560
     #+0.3024D-2*t8*t159*(0.784D-1*t9*t565*t11+0.168D0*sigmaaa/t52
     #/t569*t171-0.448D-1*t575/t4/t569/t163*t581)
      t589 = rho*t359
      t590 = t589*t200
      t593 = 1/t278/t38
      t595 = 1/t215
      t596 = t593*t98*t595
      t605 = 1/t283/t97
      t607 = t294**2
      t611 = 0.1378556646443111D0*t593*t595
      t613 = 0.4135669939329333D0*t279*t501
      t615 = 1/t290/t38
      t616 = t615*t595
      t618 = t291*t501
      t620 = -t611+t613-0.1429973890497978D1*t616+0.3431937337195148D1
     #*t618
      t625 = (-0.1378556646443111D0*t596+0.4135669939329333D0*t279
     #*t284*t211*t294+0.4135669939329333D0*t280*t501
     #+0.12407009817988D1*t93*t605*t607-0.6203504908994D0*t285*t620)
     #*t298*t97
      t628 = 1/t93/t38
      t631 = t297*t628*t97*t211
      t633 = t299*t294
      t638 = t595*t307
      t639 = 1/t302/t104*t593*t638
      t642 = t303*t615*t638
      t645 = t304*t501*t307
      t647 = t302**2
      t651 = t306**2
      t654 = 1/t647/t104*t593*t595/t651
      t672 = (0.3446391616107778D-1*t596+0.5250822119331622D0*t110
     #*t284*t292*t294-0.2187842549721509D0*t311*t616
     #+0.5250822119331622D0*t311*t618+2.D0*t111*t605*t607-1.D0*t314
     #*t620)*t318*t97
      t679 = t317/t111/t110*t97*t291*t211
      t681 = t319*t294
      t684 = t593*t117*t595
      t693 = 1/t325/t116
      t695 = t329**2
      t700 = -t611+t613-0.2201308720615045D1*t616+0.5283140929476108D1
     #*t618
      t716 = t595*t341
      t725 = t336**2
      t729 = t340**2
      s1 = 0.2505897912236993D-1*(-0.1378556646443111D0*t684
     #+0.4135669939329333D0*t279*t326*t211*t329+0.4135669939329333D0
     #*t322*t501+0.12407009817988D1*t93*t693*t695-0.6203504908994D0
     #*t327*t700)*t298*t116+0.8352993040789975D-2*t332*t628*t116*t211
     #+0.2505897912236993D-1*t333*t329+0.9995362477254242D-1/t336/t122
     #*t593*t716+0.1586317064594346D0*t337*t615*t716
     #-0.3807160955026431D0*t338*t501*t341-0.1372209729363994D0/t725
     #/t122*t593*t595/t729+0.2667310007273315D-2*
     #(0.3446391616107778D-1*t684+0.5250822119331622D0*t127*t326*t292
     #*t329-0.2187842549721509D0*t345*t616+0.5250822119331622D0*t345
     #*t618+2.D0*t128*t693*t695-1.D0*t348*t700)*t352*t116
     #+0.7002785192652656D-3*t351/t128/t127*t116*t291*t211
     #+0.2667310007273315D-2*t353*t329
      t771 = s1-0.5011795824473985D-1*t625-0.1670598608157995D-1*t631
     #-0.5011795824473985D-1*t633-0.1270249377985834D0*t639
     #-0.2015953167456128D0*t642+0.4838287601894708D0*t645
     #+0.2560822746019441D-3*t654-0.4431373767749538D-2*t672
     #-0.1163417769936259D-2*t679-0.4431373767749538D-2*t681
      t776 = t140**2
      t777 = 1/t776
      t778 = t137**2
      t784 = t144**2
      t785 = 1/t784
      t794 = 0.5011795824473985D-1*t625+0.1670598608157995D-1*t631
     #+0.5011795824473985D-1*t633+0.1270249377985834D0*t639
     #+0.2015953167456128D0*t642-0.4838287601894708D0*t645
     #-0.2560822746019441D-3*t654+0.4431373767749538D-2*t672
     #+0.1163417769936259D-2*t679+0.4431373767749538D-2*t681
     #+0.1923661050931536D1*t771*t146+0.3847322101863073D1*t359*t368
     #+0.1923661050931536D1*t135*(0.4444444444444444D0*t777*t778*t595
     #+0.2666666666666667D1*t362*t501+0.4444444444444444D0*t785*t778
     #*t595-0.2666666666666667D1*t365*t501)
      t795 = rho*t794
      t796 = 0.19D0*t795
      t814 = -0.4444444444444444D0*t777*t137*t501-0.1333333333333333D1
     #*t140*t211-0.4444444444444444D0*t785*t137*t501
     #+0.1333333333333333D1*t144*t211
      t818 = rho*(0.1923661050931536D1*t359*t200+0.1923661050931536D1
     #*t135*t814)
      t823 = 0.1423265147568D-3*t43*t513*t490*t89
      t835 = 0.384780897072D-2*t485*t43*t219
      t837 = t218*t36*t191
      t840 = t222*t217*t191
      t843 = t44*t227*t191
      t846 = t251*t38
      t849 = t71*t211
      t856 = t44*t49*(rhob*t262+t50*(-0.1111111111111111D0*t846
     #*sigmaaa+0.1111111111111111D0*t849*sigmaaa))
      t859 = rhob*t49
      t861 = 0.43129246896D-2*t513*rhoa*t859
      t862 = t135*t200
      t868 = 0.4444444444444444D0*t777*t211+0.4444444444444444D0*t785
     #*t211
      t870 = 0.3654955996769919D0*t195*t868
      t872 = t204*rhob*t207
      t874 = t178*t211
      t876 = t195*t814
      t878 = 0.3654955996769919D0*t590+t796-0.9408D-2*t565*sigmaaa*t15
     #-0.3308535951463467D0/t52+0.19D0*t818-t823-0.52583256D-2*t44*t49
     #*(2.D0*rhob*t187+0.1620551065722879D3*t182*rhob-2.D0*sigmabb)
     #+t835-0.88795591632D-3*t837-0.12234370896D-2*t840+0.385610544D-1
     #*t843-0.105166512D-1*t856-t861+0.7309911993539838D0*t862+t870
     #-0.370738512D-1*t872+0.3186864D0*t874+0.3654955996769919D0*t876
      v2rhoa2(i) = t588+t878
      t879 = t135*t415
      t884 = 1/t380/t28
      t885 = t396**2
      t890 = 1/t18/t385
      t894 = t55**2
      t900 = sigmabb**2
      t906 = 1/t392/t391
      t923 = t218*t36*t411
      t926 = t222*t217*t411
      t929 = t44*t227*t411
      t940 = t44*t49*(rhoa*t262+t50*(-0.1111111111111111D0*t846
     #*sigmabb+0.1111111111111111D0*t849*sigmabb))
      t942 = t469+t470+t471+t472+t473+0.7309911993539838D0*t879
     #-0.8064D-2*t377*t397-0.6048D-2*t22*t884*t885+0.3024D-2*t22*t381*
     #(0.784D-1*t23*t890*t25+0.168D0*sigmabb/t56/t894*t393-0.448D-1
     #*t900/t18/t894/t385*t906)-0.52583256D-2*t44*t49*(2.D0*rhoa*t407
     #+0.1620551065722879D3*rhoa*t403-2.D0*sigmaaa)-0.88795591632D-3
     #*t923-0.12234370896D-2*t926+0.385610544D-1*t929-0.105166512D-1
     #*t940-t478+t483+t488-t494
      t950 = -t814
      t954 = rho*(0.1923661050931536D1*t359*t415+0.1923661050931536D1
     #*t135*t950)
      t956 = t205*t207
      t958 = t37*t211
      t960 = t195*t950
      t962 = t589*t415
      t964 = t497-t500-t504-t550-t553-t555-0.9408D-2*t890*sigmabb*t29
     #-0.3308535951463467D0/t56+0.19D0*t954-0.370738512D-1*t956
     #+0.3186864D0*t958+0.3654955996769919D0*t960+0.3654955996769919D0
     #*t962+t796-t823+t835-t861+t870
      v2rhob2(i) = t942+t964
      t974 = -t478+t483+t488-t494+t497-t500-0.3186864D0*t503
     #-0.52583256D-2*t549-t553-t555+0.182747799838496D0*t590
      t1003 = -0.6117185448D-3*t840+0.192805272D-1*t843-0.52583256D-2
     #*t856-t861+0.3654955996769919D0*t862-0.185369256D-1*t872
     #+0.1593432D0*t874+0.182747799838496D0*t876-0.52583256D-2*t44*t49
     #*(t54+t58+t63-t69-t77+rhob*t407+rhoa*t187)-0.1593432D0*t36*t38
     #-0.3654955996769919D0*t195*t868
      v2rhoab(i) = t469+t470+t471+t472+t473+0.3654955996769919D0*t879
     #-0.44397795816D-3*t923-0.6117185448D-3*t926+0.192805272D-1*t929
     #-0.52583256D-2*t940+t974+0.95D-1*t954-0.185369256D-1*t956
     #+0.1593432D0*t958+0.182747799838496D0*t960+0.182747799838496D0
     #*t962+0.19D0*t795+0.95D-1*t818-t823+t835-0.44397795816D-3*t837
     #+t1003
      t1009 = t7*t159
      t1033 = 0.1111111111111111D0*t50*t184
      t1040 = 0.44397795816D-3*t218*t36*t437
      t1043 = 0.6117185448D-3*t222*t217*t437
      t1046 = 0.192805272D-1*t44*t227*t437
      t1047 = 0.4690740740740741D-2*t232
      t1048 = 0.6462962962962963D-2*t234
      t1049 = 0.2255574074074074D-2*t238
      t1057 = 0.1333333333333333D1*rho
      t1061 = 0.52583256D-2*t44*t49*(t50*(-t1047-t1048+t1049
     #-0.1111111111111111D0*t251*rhoa*t38+0.1111111111111111D0*t432
     #*t211)+t1057)
      t1063 = t44*t859*t62
      t1064 = 0.52583256D-2*t1063
      t1066 = t218*t36*t443
      t1067 = 0.44397795816D-3*t1066
      t1069 = t222*t217*t443
      t1070 = 0.6117185448D-3*t1069
      t1072 = t44*t227*t443
      t1073 = 0.192805272D-1*t1072
      t1078 = t44*t49*(t50*t240-0.1333333333333333D1*rho)
      t1079 = 0.52583256D-2*t1078
      v2rhoasigmaaa(i) = 0.4032D-2*t154*t15-0.4032D-2*t155*t427
     #+0.3024D-2*t1009*t174-0.6048D-2*t8*t559*t174*t426+0.3024D-2*t8
     #*t159*(-0.168D-1*t420*t154*t11-0.504D-1*t165*t171+0.168D-1
     #*sigmaaa/t4/t569/t51*t581)-0.52583256D-2*t44*t49*(rhob*t435
     #-t1033)-t1040-t1043+t1046-t1061-t1064-t1067-t1070+t1073-t1079
      t1081 = 0.88795591632D-3*t1066
      t1082 = 0.12234370896D-2*t1069
      t1083 = 0.385610544D-1*t1072
      t1084 = 0.105166512D-1*t1078
      v2rhoasigmaab(i) = -0.105166512D-1*t1063-t1081-t1082+t1083-t1084
      t1093 = 0.44397795816D-3*t218*t36*t465
      t1096 = 0.6117185448D-3*t222*t217*t465
      t1099 = 0.192805272D-1*t44*t227*t465
      t1110 = 0.52583256D-2*t44*t49*(t50*(-t1047-t1048+t1049
     #-0.1111111111111111D0*t251*rhob*t38+0.1111111111111111D0*t460
     #*t211)+t1057)
      v2rhoasigmabb(i) = -0.52583256D-2*t44*t49*(rhob*t463-2.D0*rhoa)
     #-t1093-t1096+t1099-t1110-t1064-t1067-t1070+t1073-t1079
      t1119 = t44*t49*rhoa*t62
      t1120 = 0.52583256D-2*t1119
      v2rhobsigmaaa(i) = -0.52583256D-2*t44*t49*(rhoa*t435-2.D0*rhob)
     #-t1040-t1043+t1046-t1061-t1120-t1067-t1070+t1073-t1079
      v2rhobsigmaab(i) = -0.105166512D-1*t1119-t1081-t1082+t1083-t1084
      t1126 = t21*t381
      v2rhobsigmabb(i) = 0.4032D-2*t376*t29-0.4032D-2*t377*t457
     #+0.3024D-2*t1126*t396-0.6048D-2*t22*t884*t396*t456+0.3024D-2*t22
     #*t381*(-0.168D-1*t450*t376*t25-0.504D-1*t387*t393+0.168D-1
     #*sigmabb/t18/t894/t55*t906)-0.52583256D-2*t44*t49*(rhoa*t463
     #-t1033)-t1093-t1096+t1099-t1110-t1120-t1067-t1070+t1073-t1079
      t1155 = t426**2
      v2sigmaaa2(i) = 0.6048D-2*t1009*t426-0.6048D-2*t8*t559*t1155
     #+0.3024D-2*t8*t159*(-0.63D-2/t9/sigmaaa*t7*t11+0.63D-2/sigmaaa
     #*t167*t171-0.63D-2/t4/t569/rhoa*t581)
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t1179 = t456**2
      v2sigmabb2(i) = 0.6048D-2*t1126*t456-0.6048D-2*t22*t884*t1179
     #+0.3024D-2*t22*t381*(-0.63D-2/t23/sigmabb*t21*t25+0.63D-2
     #/sigmabb*t389*t393-0.63D-2/t18/t894/rhob*t906)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      v2rhob2(i) = 0.0d0
      v2rhoab(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2rhoasigmaab(i) = 0.0d0
      v2rhoasigmabb(i) = 0.0d0
      v2rhobsigmaaa(i) = 0.0d0
      v2rhobsigmaab(i) = 0.0d0
      v2rhobsigmabb(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      v2sigmaab2(i) = 0.0d0
      v2sigmabb2(i) = 0.0d0
      v2sigmaaaab(i) = 0.0d0
      v2sigmaaabb(i) = 0.0d0
      v2sigmaabbb(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end
      
      
      subroutine rks_xc_b3lyp
     & (ideriv,npt,rhoa1,sigmaaa1,
     &  zk,vrhoa,vsigmaaa,
     &  v2rhoa2,v2rhoasigmaaa,v2sigmaaa2)
c
c     P.J. Stephens, F.J. Devlin, C.F. Chabalowski, M.J. Frisch
c     Ab initio calculation of vibrational absorption and circular 
c     dichroism spectra using density functional force fields
c     J. Phys. Chem. 98 (1994) 11623-11627
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt)
      real*8 sigmaaa1(npt)
      real*8 zk(npt),vrhoa(npt),vsigmaaa(npt)
      real*8 v2rhoa2(npt),v2rhoasigmaaa(npt),v2sigmaaa2(npt)
      parameter(tol=1.0d-20)
      
      if(ideriv.eq.0) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t5 = 1/t3
      t7 = dsqrt(sigma)
      t8 = t7*t5
      t10 = dlog(0.1259921049894873D1*t8+dsqrt(1+0.1587401051968199D1
     #*t8**2))
      t17 = 1/t2
      t20 = 1/(1.D0+0.349D0*t17)
      t23 = 0.2533D0*t17
      t24 = dexp(-t23)
      t26 = rho**2
      t28 = t2**2
      t34 = t17*t20
      t56 = 1/rho
      t57 = t56**(1.D0/3.D0)
      t59 = t56**(1.D0/6.D0)
      t62 = 1/(0.6203504908994D0*t57+0.1029581201158544D2*t59
     #+0.427198D2)
      t65 = dlog(0.6203504908994D0*t57*t62)
      t71 = datan(0.448998886412873D-1/(0.1575246635799487D1*t59
     #+0.13072D2))
      t75 = (0.7876233178997433D0*t59+0.409286D0)**2
      t77 = dlog(t75*t62)
      zk(i) = -0.5908470131056179D0*t3-0.3810001254882096D-2*t5*sigma/
     #(1.D0+0.317500104573508D-1*t8*t10)-0.398358D-1*t20*rho
     #-0.52583256D-2*t24*t20/t28/t26/rho*(0.25D0*t26*
     #(0.1148493600075277D2*t28*t26+(0.2611111111111111D1
     #-0.9850555555555556D-1*t17-0.1357222222222222D0*t34)*sigma-0.5D0
     #*(0.25D1-0.1407222222222222D-1*t17-0.1938888888888889D-1*t34)
     #*sigma-0.2777777777777778D-1*(t23+0.349D0*t34-11.D0)*sigma)
     #-0.4583333333333333D0*t26*sigma)+0.19D0*rho*(0.310907D-1*t65
     #+0.205219729378375D2*t71+0.4431373767749538D-2*t77)
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t5 = 1/t3
      t6 = t5*sigma
      t7 = dsqrt(sigma)
      t8 = t7*t5
      t10 = dlog(0.1259921049894873D1*t8+dsqrt(1+0.1587401051968199D1
     #*t8**2))
      t13 = 1.D0+0.317500104573508D-1*t8*t10
      t14 = 1/t13
      t17 = 1/t2
      t19 = 1.D0+0.349D0*t17
      t20 = 1/t19
      t23 = 0.2533D0*t17
      t24 = dexp(-t23)
      t25 = t24*t20
      t26 = rho**2
      t28 = t2**2
      t30 = 1/t28/t26/rho
      t31 = t28*t26
      t34 = t17*t20
      t36 = 0.2611111111111111D1-0.9850555555555556D-1*t17
     #-0.1357222222222222D0*t34
      t44 = t23+0.349D0*t34-11.D0
      t47 = 0.1148493600075277D2*t31+t36*sigma-0.5D0*(0.25D1
     #-0.1407222222222222D-1*t17-0.1938888888888889D-1*t34)*sigma
     #-0.2777777777777778D-1*t44*sigma
      t52 = 0.25D0*t26*t47-0.4583333333333333D0*t26*sigma
      t56 = 1/rho
      t57 = t56**(1.D0/3.D0)
      t59 = t56**(1.D0/6.D0)
      t61 = 0.6203504908994D0*t57+0.1029581201158544D2*t59+0.427198D2
      t62 = 1/t61
      t65 = dlog(0.6203504908994D0*t57*t62)
      t68 = 0.1575246635799487D1*t59+0.13072D2
      t71 = datan(0.448998886412873D-1/t68)
      t74 = 0.7876233178997433D0*t59+0.409286D0
      t75 = t74**2
      t77 = dlog(t75*t62)
      zk(i) = -0.5908470131056179D0*t3-0.3810001254882096D-2*t6*t14
     #-0.398358D-1*t20*rho-0.52583256D-2*t25*t30*t52+0.19D0*rho*
     #(0.310907D-1*t65+0.205219729378375D2*t71+0.4431373767749538D-2
     #*t77)
      t84 = 1/t2/t26
      t88 = t13**2
      t89 = 1/t88
      t94 = 1/t31
      t98 = dsqrt(1.D0+0.1587401051968199D1*sigma*t94)
      t99 = 1/t98
      t109 = t28*rho
      t112 = t44*t56*sigma
      t117 = rho*sigma
      t123 = t19**2
      t124 = 1/t123
      t127 = t26**2
      t129 = 1/t127/rho
      t144 = t5*t20
      t146 = 1/t109
      t147 = t146*t124
      t175 = t57**2
      t176 = 1/t175
      t178 = 1/t26
      t181 = t61**2
      t182 = 1/t181
      t186 = t59**2
      t187 = t186**2
      t189 = 1/t187/t59
      t190 = t189*t178
      t192 = -0.2067834969664667D0*t176*t178-0.1715968668597574D1*t190
      t200 = t68**2
      t201 = 1/t200
      s1 = -0.7877960174741572D0*t2+0.5080001673176129D-2*t84*sigma
     #*t14+0.1905000627441048D-2*t6*t89*(-0.8466669455293548D-1*t7*t84
     #*t10-0.106673350692263D0*sigma*t30*t99)-0.398358D-1*t20
     #-0.52583256D-2*t25*t30*(0.5D0*rho*t47+0.25D0*t26*
     #(0.3062649600200738D2*t109-0.2777777777777778D-1*t112)-0.25D0
     #*t117)-0.46342314D-2*t124*t17-0.44397795816D-3*t129*t24*t20*t52
      s2 = s1-0.6117185448D-3*t24*t124*t129*t52+0.192805272D-1*t25/t28
     #/t127*t52-0.52583256D-2*t25*t30*(0.25D0*t26*(
     #(0.3283518518518519D-1*t5+0.4524074074074074D-1*t144
     #-0.1578901851851852D-1*t147)*sigma-0.5D0*(0.4690740740740741D-2
     #*t5+0.6462962962962963D-2*t144-0.2255574074074074D-2*t147)*sigma
     #-0.2777777777777778D-1*(-0.8443333333333333D-1*t5
     #-0.1163333333333333D0*t144+0.4060033333333333D-1*t147)*sigma
     #+0.2777777777777778D-1*t112)-0.6666666666666667D0*t117)
      vrhoa(i) = s2+0.5907233D-2*t65+0.3899174858189126D1*t71
     #+0.8419610158724123D-3*t77+0.19D0*rho*(0.5011795824473985D-1*(
     #-0.2067834969664667D0*t176*t62*t178-0.6203504908994D0*t57*t182
     #*t192)/t57*t61+0.2419143800947354D0*t201*t189*t178/(1.D0
     #+0.2016D-2*t201)+0.4431373767749538D-2*(-0.2625411059665811D0
     #*t74*t62*t190-1.D0*t75*t182*t192)/t75*t61)
      vsigmaaa(i) = -0.1524000501952839D-1*t5*t14
     #+0.3810001254882096D-2*t6*t89*(0.6350002091470161D-1/t7*t5*t10
     #+0.8000501301919725D-1*t94*t99)+0.5842584D-3*t25*t146
     #-0.210333024D-1*t25*t30*(0.25D0*t26*t36-0.6666666666666667D0*t26)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t5 = 1/t3
      t6 = t5*sigma
      t7 = dsqrt(sigma)
      t8 = t7*t5
      t10 = dlog(0.1259921049894873D1*t8+dsqrt(1+0.1587401051968199D1
     #*t8**2))
      t13 = 1.D0+0.317500104573508D-1*t8*t10
      t14 = 1/t13
      t17 = 1/t2
      t19 = 1.D0+0.349D0*t17
      t20 = 1/t19
      t23 = 0.2533D0*t17
      t24 = dexp(-t23)
      t25 = t24*t20
      t26 = rho**2
      t27 = t26*rho
      t28 = t2**2
      t30 = 1/t28/t27
      t31 = t28*t26
      t32 = 0.1148493600075277D2*t31
      t34 = t17*t20
      t36 = 0.2611111111111111D1-0.9850555555555556D-1*t17
     #-0.1357222222222222D0*t34
      t37 = t36*sigma
      t42 = 0.5D0*(0.25D1-0.1407222222222222D-1*t17
     #-0.1938888888888889D-1*t34)*sigma
      t44 = t23+0.349D0*t34-11.D0
      t46 = 0.2777777777777778D-1*t44*sigma
      t47 = t32+t37-t42-t46
      t52 = 0.25D0*t26*t47-0.4583333333333333D0*t26*sigma
      t56 = 1/rho
      t57 = t56**(1.D0/3.D0)
      t59 = t56**(1.D0/6.D0)
      t61 = 0.6203504908994D0*t57+0.1029581201158544D2*t59+0.427198D2
      t62 = 1/t61
      t65 = dlog(0.6203504908994D0*t57*t62)
      t68 = 0.1575246635799487D1*t59+0.13072D2
      t71 = datan(0.448998886412873D-1/t68)
      t74 = 0.7876233178997433D0*t59+0.409286D0
      t75 = t74**2
      t77 = dlog(t75*t62)
      zk(i) = -0.5908470131056179D0*t3-0.3810001254882096D-2*t6*t14
     #-0.398358D-1*t20*rho-0.52583256D-2*t25*t30*t52+0.19D0*rho*
     #(0.310907D-1*t65+0.205219729378375D2*t71+0.4431373767749538D-2
     #*t77)
      t84 = 1/t2/t26
      t85 = t84*sigma
      t88 = t13**2
      t89 = 1/t88
      t94 = 1/t31
      t97 = 1.D0+0.1587401051968199D1*sigma*t94
      t98 = dsqrt(t97)
      t99 = 1/t98
      t102 = -0.8466669455293548D-1*t7*t84*t10-0.106673350692263D0
     #*sigma*t30*t99
      t103 = t89*t102
      t109 = t28*rho
      t111 = t44*t56
      t112 = t111*sigma
      t114 = 0.3062649600200738D2*t109-0.2777777777777778D-1*t112
      t117 = rho*sigma
      t119 = 0.5D0*rho*t47+0.25D0*t26*t114-0.25D0*t117
      t123 = t19**2
      t124 = 1/t123
      t127 = t26**2
      t128 = t127*rho
      t129 = 1/t128
      t130 = t129*t24
      t131 = t20*t52
      t134 = t24*t124
      t139 = 1/t28/t127
      t144 = t5*t20
      t146 = 1/t109
      t147 = t146*t124
      t149 = 0.3283518518518519D-1*t5+0.4524074074074074D-1*t144
     #-0.1578901851851852D-1*t147
      t160 = -0.8443333333333333D-1*t5-0.1163333333333333D0*t144
     #+0.4060033333333333D-1*t147
      t164 = t149*sigma-0.5D0*(0.4690740740740741D-2*t5
     #+0.6462962962962963D-2*t144-0.2255574074074074D-2*t147)*sigma
     #-0.2777777777777778D-1*t160*sigma+0.2777777777777778D-1*t112
      t168 = 0.25D0*t26*t164-0.6666666666666667D0*t117
      t175 = t57**2
      t176 = 1/t175
      t177 = t176*t62
      t178 = 1/t26
      t181 = t61**2
      t182 = 1/t181
      t183 = t57*t182
      t186 = t59**2
      t187 = t186**2
      t188 = t187*t59
      t189 = 1/t188
      t190 = t189*t178
      t192 = -0.2067834969664667D0*t176*t178-0.1715968668597574D1*t190
      t195 = -0.2067834969664667D0*t177*t178-0.6203504908994D0*t183*t192
      t196 = 1/t57
      t197 = t195*t196
      t198 = t197*t61
      t200 = t68**2
      t201 = 1/t200
      t202 = t201*t189
      t204 = 1.D0+0.2016D-2*t201
      t205 = 1/t204
      t207 = t202*t178*t205
      t209 = t74*t62
      t212 = t75*t182
      t215 = -0.2625411059665811D0*t209*t190-1.D0*t212*t192
      t216 = 1/t75
      t217 = t215*t216
      t218 = t217*t61
      vrhoa(i) = -0.7877960174741572D0*t2+0.5080001673176129D-2*t85
     #*t14+0.1905000627441048D-2*t6*t103-0.398358D-1*t20-0.52583256D-2
     #*t25*t30*t119-0.46342314D-2*t124*t17-0.44397795816D-3*t130*t131
     #-0.6117185448D-3*t134*t129*t52+0.192805272D-1*t25*t139*t52
     #-0.52583256D-2*t25*t30*t168+0.5907233D-2*t65
     #+0.3899174858189126D1*t71+0.8419610158724123D-3*t77+0.19D0*rho*
     #(0.5011795824473985D-1*t198+0.2419143800947354D0*t207
     #+0.4431373767749538D-2*t218)
      t225 = 1/t7
      t231 = 0.6350002091470161D-1*t225*t5*t10+0.8000501301919725D-1
     #*t94*t99
      t232 = t89*t231
      t240 = 0.25D0*t26*t36-0.6666666666666667D0*t26
      vsigmaaa(i) = -0.1524000501952839D-1*t5*t14
     #+0.3810001254882096D-2*t6*t232+0.5842584D-3*t25*t146
     #-0.210333024D-1*t25*t30*t240
      t254 = 1/t2/t27
      t258 = rho*t114
      t269 = 1/t123/t19
      t271 = t127*t26
      t273 = 1/t2/t271
      t277 = 1/t271
      t287 = t84*t20
      t289 = t94*t124
      t291 = 1/t27
      t292 = t291*t269
      t311 = t160*t56*sigma
      t314 = t44*t178*sigma
      s1 = -0.177591183264D-2*t130*t20*t119-0.24468741792D-2*t134*t129
     #*t119+0.771221088D-1*t25*t139*t119-0.2370667447482193D-1*t254
     #*sigma*t14-0.52583256D-2*t25*t30*(t258+0.2552208000167282D2*t31
     #-0.5D0*sigma)+0.771221088D-1*t25*t139*t168
      s2 = s1-0.2846530295136D-3*t24*t269*t273*t52+0.106031214432D-1
     #*t134*t277*t52-0.1799515872D0*t25/t28/t128*t52
      t342 = s2-0.105166512D-1*t25*t30*(0.25D0*t26*((
     #-0.4378024691358025D-1*t84-0.6032098765432099D-1*t287
     #+0.3157803703703704D-1*t289-0.3673578308641975D-2*t292)*sigma
     #-0.5D0*(-0.6254320987654321D-2*t84-0.8617283950617284D-2*t287
     #+0.4511148148148148D-2*t289-0.5247969012345679D-3*t292)*sigma
     #-0.2777777777777778D-1*(0.1125777777777778D0*t84
     #+0.1551111111111111D0*t287-0.8120066666666667D-1*t289
     #+0.9446344222222222D-2*t292)*sigma+0.5555555555555556D-1*t311
     #-0.5555555555555556D-1*t314)-0.6666666666666667D0*sigma)
     #+0.769561794144D-2*t277*t24*t131-0.52583256D-2*t25*t30*(t32+t37
     #-t42-t46+t258)-0.210333024D-1*t25*t30*(0.5D0*rho*t164+0.25D0*t26
     #*(-0.2777777777777778D-1*t311+0.2777777777777778D-1*t314))
      t346 = t273*t24
      t363 = sigma**2
      t369 = 1/t98/t97
      t377 = 1/t88/t13
      t378 = t102**2
      t392 = 1/t175/t56
      t394 = 1/t127
      t395 = t392*t62*t394
      t404 = 1/t181/t61
      t406 = t192**2
      t414 = 1/t188/t56
      t415 = t414*t394
      t417 = t189*t291
      t419 = -0.1378556646443111D0*t392*t394+0.4135669939329333D0*t176
     #*t291-0.1429973890497978D1*t415+0.3431937337195148D1*t417
      t437 = t394*t205
      t446 = t200**2
      t450 = t204**2
      s1 = -0.177591183264D-2*t130*t20*t168-0.74973077867952D-4*t346
     #*t131-0.20659774319712D-3*t346*t124*t52+0.1838549288719989D0
     #*t207+0.3808964826600229D-1*t198+0.3367844063489649D-2*t218
     #-0.1016000334635226D-1*t85*t103
      s2 = s1+0.1905000627441048D-2*t6*t89*(0.3951112412470322D0*t7
     #*t254*t10+0.106673350692263D1*sigma*t139*t99
     #-0.4515557042823225D0*t363/t2/t127/t27*t369)
     #-0.3810001254882096D-2*t6*t377*t378-0.24468741792D-2*t134*t129
     #*t168
      s3 = s2-0.5251973449827715D0/t28
      s4 = s3-0.61789752D-2*t124*t5
      s5 = s4
      s7 = -0.21564623448D-2*t269*t146
      s8 = 0.38D0*rho*(0.5011795824473985D-1*(-0.1378556646443111D0
     #*t395+0.4135669939329333D0*t176*t182*t178*t192
     #+0.4135669939329333D0*t177*t291+0.12407009817988D1*t57*t404*t406
     #-0.6203504908994D0*t183*t419)*t196*t61+0.1670598608157995D-1
     #*t195/t57/t56*t61*t178+0.5011795824473985D-1*t197*t192
     #+0.1270249377985834D0/t200/t68*t392*t437+0.2015953167456128D0
     #*t201*t414*t437-0.4838287601894708D0*t202*t291*t205
     #-0.2560822746019441D-3/t446/t68*t392*t394/t450
     #+0.4431373767749538D-2*(0.3446391616107778D-1*t395
     #+0.5250822119331622D0*t74*t182*t190*t192-0.2187842549721509D0
     #*t209*t415+0.5250822119331622D0*t209*t417+2.D0*t75*t404*t406
     #-1.D0*t212*t419)*t216*t61+0.1163417769936259D-2*t215/t75/t74*t61
     #*t189*t178+0.4431373767749538D-2*t217*t192)
      s6 = s7+s8
      t485 = s5+s6
      v2rhoa2(i) = t342+t485
      t490 = t5*t89
      s1 = 0.2032000669270451D-1*t84*t14-0.5080001673176129D-2*t85
     #*t232+0.7620002509764193D-2*t490*t102-0.3810001254882096D-2*t6
     #*t377*t102*t231+0.1905000627441048D-2*t6*t89*(
     #-0.169333389105871D0*t225*t84*t10-0.640040104153578D0*t30*t99
     #+0.3386667782117419D0*sigma*t273*t369)-0.52583256D-2*t25*t30*(
     #-0.9444444444444444D0*rho-0.2777777777777778D-1*rho*t44)
     #+0.4933088424D-4*t291*t24*t20
      v2rhoasigmaaa(i) = s1+0.679687272D-4*t134*t291+0.80822412D-2*t25
     #*t94-0.105166512D-1*t25*t30*(0.25D0*t26*(-0.3D-22*t144
     #+0.5555555555555556D-1*t111)+0.1333333333333333D1*rho)
     #-0.105166512D-1*t25*t94*t36-0.177591183264D-2*t130*t20*t240
     #-0.24468741792D-2*t134*t129*t240+0.771221088D-1*t25*t139*t240
     #-0.210333024D-1*t25*t30*(0.25D0*t26*t149-0.1333333333333333D1*rho)
      t554 = t231**2
      v2sigmaaa2(i) = 0.3048001003905677D-1*t490*t231
     #-0.7620002509764193D-2*t6*t377*t554+0.3810001254882096D-2*t6*t89
     #*(-0.1270000418294032D0/t7/sigma*t5*t10+0.1600100260383945D0
     #/sigma*t94*t99-0.2540000836588064D0/t2/t128*t369)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end

c:XC_B3LYPsubrend
